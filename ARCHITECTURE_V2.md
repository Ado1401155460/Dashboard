# ğŸš€ é‡åŒ–äº¤æ˜“åˆ†æç³»ç»Ÿ v2.0 - åŒå±‚æ•°æ®åŒæ­¥æ¶æ„

## ğŸ“Š ç³»ç»Ÿæ¶æ„

### æ•°æ®åŒæ­¥ç­–ç•¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åŒå±‚æ•°æ®åŒæ­¥æ¶æ„                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  ç¬¬ä¸€å±‚ï¼šN8N è½®è¯¢åŒæ­¥ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰                              â”‚
â”‚  â”œâ”€ å®šæœŸè½®è¯¢ OANDA API                                        â”‚
â”‚  â”œâ”€ æ•°æ®å›è¡¥å’ŒåŒæ­¥                                            â”‚
â”‚  â””â”€ å†™å…¥ PostgreSQL                                          â”‚
â”‚                                                               â”‚
â”‚  ç¬¬äºŒå±‚ï¼šOANDA Webhook å®æ—¶æ¨é€                               â”‚
â”‚  â”œâ”€ è®¢å•å˜åŠ¨å®æ—¶é€šçŸ¥                                          â”‚
â”‚  â”œâ”€ äº¤æ˜“çŠ¶æ€å®æ—¶æ›´æ–°                                          â”‚
â”‚  â””â”€ è´¦æˆ·æ‘˜è¦å®æ—¶åŒæ­¥                                          â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æ¥æº

| æ•°æ®ç±»å‹ | æ¥æº | è¯´æ˜ |
|---------|------|------|
| è®¢å•åŸºæœ¬ä¿¡æ¯ | PostgreSQL (trades è¡¨) | é™æ€æ•°æ® |
| è´¦æˆ·æ‘˜è¦ | PostgreSQL (account_summary è¡¨) | å®šæœŸæ›´æ–° |
| å®æ—¶ä»·æ ¼ | OANDA API | åŠ¨æ€è·å– |
| æµ®åŠ¨ç›ˆäº | è®¡ç®—ï¼ˆå®æ—¶ä»·æ ¼ - å…¥åœºä»·æ ¼ï¼‰ | å®æ—¶è®¡ç®— |

---

## ğŸ—„ï¸ æ•°æ®åº“è¡¨ç»“æ„

### trades è¡¨ï¼ˆäº¤æ˜“è®°å½•ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | integer | ä¸»é”® |
| intent_id | text | è®¢å•å”¯ä¸€æ ‡è¯† |
| symbol | text | äº¤æ˜“å¯¹ |
| direction | text | æ–¹å‘ï¼ˆlong/shortï¼‰ |
| units | double precision | æ•°é‡ |
| order_type | text | è®¢å•ç±»å‹ |
| entry_price | double precision | å…¥åœºä»·æ ¼ |
| current_price | double precision | å½“å‰ä»·æ ¼ |
| exit_price | double precision | å‡ºåœºä»·æ ¼ |
| stop_loss | double precision | æ­¢æŸä»· |
| take_profit | double precision | æ­¢ç›ˆä»· |
| status | text | çŠ¶æ€ï¼ˆpending/open/closedï¼‰ |
| ai_article | text | AI åˆ†ææŠ¥å‘Š |
| analysisJson | jsonb | åˆ†ææ•°æ® |
| confidence | double precision | ä¿¡å¿ƒæŒ‡æ•° |
| oanda_order_id | text | OANDA è®¢å• ID |
| oanda_trade_id | text | OANDA äº¤æ˜“ ID |
| **realized_pl** | numeric | **å·²å®ç°ç›ˆäº** âœ¨ |
| **financing** | numeric | **èèµ„è´¹ç”¨** âœ¨ |
| **commission** | numeric | **ä½£é‡‘** âœ¨ |
| **close_time** | timestamp | **å¹³ä»“æ—¶é—´** âœ¨ |
| **close_reason** | text | **å¹³ä»“åŸå› ** âœ¨ |
| created_at | timestamp | åˆ›å»ºæ—¶é—´ |
| updated_at | timestamp | æ›´æ–°æ—¶é—´ |

### account_summary è¡¨ï¼ˆè´¦æˆ·æ‘˜è¦ï¼‰âœ¨ æ–°å¢

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| account_id | text | è´¦æˆ· IDï¼ˆä¸»é”®ï¼‰ |
| currency | varchar | è´§å¸ |
| balance | numeric | è´¦æˆ·ä½™é¢ |
| nav | numeric | å‡€èµ„äº§ä»·å€¼ |
| unrealized_pl | numeric | æœªå®ç°ç›ˆäº |
| pl | numeric | æ€»ç›ˆäº |
| resettable_pl | numeric | å¯é‡ç½®ç›ˆäº |
| margin_used | numeric | å·²ç”¨ä¿è¯é‡‘ |
| margin_available | numeric | å¯ç”¨ä¿è¯é‡‘ |
| margin_call_percent | numeric | ä¿è¯é‡‘å‚¬ç¼´ç™¾åˆ†æ¯” |
| position_value | numeric | æŒä»“ä»·å€¼ |
| open_trade_count | integer | æŒä»“æ•°é‡ |
| open_order_count | integer | æŒ‚å•æ•°é‡ |
| last_transaction_id | text | æœ€åäº¤æ˜“ ID |
| updated_at | timestamp | æ›´æ–°æ—¶é—´ |

---

## ğŸ”Œ API ç«¯ç‚¹

### è®¢å•æ¨¡å—
```
GET  /api/orders/pending              # è·å–æŒ‚å•åˆ—è¡¨
GET  /api/orders/pending/{intent_id}  # è·å–æŒ‚å•è¯¦æƒ…
```

### å¤´å¯¸æ¨¡å—
```
GET  /api/positions/open              # è·å–æŒä»“åˆ—è¡¨
GET  /api/positions/open/{intent_id}  # è·å–æŒä»“è¯¦æƒ…
```

### äº¤æ˜“åˆ†æ
```
GET  /api/analytics/stats             # è·å–è´¦æˆ·ç»Ÿè®¡ï¼ˆaccount_summary + tradesï¼‰
GET  /api/analytics/equity-curve      # è·å–æ”¶ç›Šæ›²çº¿ï¼ˆtradesï¼‰
GET  /api/analytics/history           # è·å–å†å²äº¤æ˜“è®°å½•ï¼ˆtradesï¼‰
```

### Webhookï¼ˆæ–°å¢ï¼‰âœ¨
```
POST /api/webhook/oanda               # OANDA Webhook ç«¯ç‚¹
POST /api/webhook/sync/account        # æ‰‹åŠ¨åŒæ­¥è´¦æˆ·æ‘˜è¦
```

---

## ğŸ”„ æ•°æ®åŒæ­¥æµç¨‹

### ç¬¬ä¸€å±‚ï¼šN8N è½®è¯¢åŒæ­¥

**æ‚¨å·²åœ¨ N8N ä¸­å®ç°**ï¼š
1. å®šæ—¶è½®è¯¢ OANDA API
2. è·å–è®¢å•å’Œäº¤æ˜“æ•°æ®
3. å†™å…¥ PostgreSQL trades è¡¨
4. æ•°æ®å›è¡¥å’ŒåŒæ­¥

### ç¬¬äºŒå±‚ï¼šOANDA Webhook å®æ—¶æ¨é€

**éœ€è¦åœ¨ OANDA é…ç½® Webhook**ï¼š

1. ç™»å½• OANDA è´¦æˆ·
2. è¿›å…¥ API è®¾ç½®
3. é…ç½® Webhook URLï¼š
   ```
   https://your-backend.zeabur.app/api/webhook/oanda
   ```

4. é€‰æ‹©äº‹ä»¶ç±»å‹ï¼š
   - ORDER_FILLï¼ˆè®¢å•æˆäº¤ï¼‰
   - ORDER_CANCELï¼ˆè®¢å•å–æ¶ˆï¼‰
   - TRADE_CLOSEï¼ˆäº¤æ˜“å¹³ä»“ï¼‰
   - TRADE_UPDATEï¼ˆäº¤æ˜“æ›´æ–°ï¼‰

**Webhook å¤„ç†é€»è¾‘**ï¼š
- æ¥æ”¶ OANDA æ¨é€çš„äº‹ä»¶
- è§£æäº‹ä»¶ç±»å‹å’Œæ•°æ®
- æ›´æ–° PostgreSQL æ•°æ®åº“
- åŒæ­¥è´¦æˆ·æ‘˜è¦

---

## ğŸ¯ å®æ—¶ä»·æ ¼è®¡ç®—

### æµ®åŠ¨ç›ˆäºè®¡ç®—å…¬å¼

**åšå¤šï¼ˆLongï¼‰**ï¼š
```
æœªå®ç°ç›ˆäº = (å½“å‰ä»·æ ¼ - å…¥åœºä»·æ ¼) Ã— æ•°é‡
```

**åšç©ºï¼ˆShortï¼‰**ï¼š
```
æœªå®ç°ç›ˆäº = (å…¥åœºä»·æ ¼ - å½“å‰ä»·æ ¼) Ã— æ•°é‡
```

### æ•°æ®æµç¨‹

```
1. ä» trades è¡¨è¯»å–è®¢å•åŸºæœ¬ä¿¡æ¯
   â†“
2. è°ƒç”¨ OANDA API è·å–å®æ—¶ä»·æ ¼
   â†“
3. è®¡ç®—æµ®åŠ¨ç›ˆäº
   â†“
4. è¿”å›ç»™å‰ç«¯æ˜¾ç¤º
```

---

## ğŸ“ ä½¿ç”¨è¯´æ˜

### 1. é…ç½® OANDA Webhook

åœ¨ OANDA å¹³å°é…ç½® Webhook URLï¼š
```
https://dashboardbackend.zeabur.app/api/webhook/oanda
```

### 2. æµ‹è¯• Webhook

æ‰‹åŠ¨è§¦å‘è´¦æˆ·åŒæ­¥ï¼š
```bash
curl -X POST https://dashboardbackend.zeabur.app/api/webhook/sync/account
```

### 3. æŸ¥çœ‹æ—¥å¿—

åœ¨ Zeabur åç«¯æœåŠ¡ä¸­æŸ¥çœ‹æ—¥å¿—ï¼Œç¡®è®¤ Webhook æ˜¯å¦æ­£å¸¸æ¥æ”¶ã€‚

### 4. N8N å·¥ä½œæµ

ç¡®ä¿ N8N å·¥ä½œæµåŒ…å«ä»¥ä¸‹æ­¥éª¤ï¼š
1. å®šæ—¶è§¦å‘ï¼ˆå¦‚æ¯åˆ†é’Ÿï¼‰
2. è°ƒç”¨ OANDA API è·å–æ•°æ®
3. å†™å…¥ PostgreSQL trades è¡¨
4. å†™å…¥ PostgreSQL account_summary è¡¨

---

## ğŸš€ éƒ¨ç½²æ›´æ–°

### æ¨é€ä»£ç 
```bash
cd C:\Users\Administrator\Desktop\Dashboard
git add .
git commit -m "feat: implement dual-layer data sync architecture v2.0"
git push origin main
```

### é‡æ–°éƒ¨ç½²
åœ¨ Zeabur æ§åˆ¶å°é‡æ–°éƒ¨ç½²åç«¯æœåŠ¡ã€‚

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **Webhook å®‰å…¨æ€§**ï¼šå»ºè®®æ·»åŠ ç­¾åéªŒè¯
2. **æ•°æ®ä¸€è‡´æ€§**ï¼šN8N å’Œ Webhook å¯èƒ½åŒæ—¶æ›´æ–°æ•°æ®ï¼Œéœ€è¦å¤„ç†å¹¶å‘
3. **é”™è¯¯å¤„ç†**ï¼šWebhook å¤±è´¥æ—¶ï¼ŒN8N è½®è¯¢ä½œä¸ºå¤‡ä»½
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šå®æ—¶ä»·æ ¼è·å–æœ‰é¢‘ç‡é™åˆ¶ï¼Œæ³¨æ„ç¼“å­˜

---

## ğŸ“Š ç³»ç»Ÿä¼˜åŠ¿

âœ… **åŒå±‚åŒæ­¥**ï¼šN8N è½®è¯¢ + Webhook å®æ—¶æ¨é€  
âœ… **æ•°æ®å®Œæ•´æ€§**ï¼šè½®è¯¢ä¿è¯æ•°æ®ä¸ä¸¢å¤±  
âœ… **å®æ—¶æ€§**ï¼šWebhook ä¿è¯å³æ—¶æ›´æ–°  
âœ… **å¯é æ€§**ï¼šä¸¤å±‚äº’ä¸ºå¤‡ä»½  
âœ… **çµæ´»æ€§**ï¼šå¯ç‹¬ç«‹è°ƒæ•´æ¯å±‚çš„é¢‘ç‡  

---

**ç‰ˆæœ¬**: 2.0.0  
**æ›´æ–°æ—¥æœŸ**: 2026-02-06

